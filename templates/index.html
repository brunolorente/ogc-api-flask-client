<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OGC API demo client</title>
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <!-- Popper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <!-- Bootstrap CSS and JS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <!-- Leaflet -->
        <style>
            #mapid { height: 480px; }
        </style>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
         <!-- Make sure you put this AFTER Leaflet's CSS -->
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
        <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    </head>

    <body>

        <!-- map container -->
        <div id="mapid"></div>
     
        <div class="container">
            <div class="row">
                <div class="col-4">
                    <label for="collectionId">Feature collection ID</label>
                    <input type="text" name="collectionId" id="collectionId" class="form-control" value="AgricultureSrf">
                    <button id="getCollectionItems" class="btn btn-primary">Get items</button>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <pre id="result"></pre>
                </div>
            </div>
        </div>

        <!-- Document root -->
        <script>
            $SCRIPT_ROOT = {{request.root_url|tojson|safe}};
        </script>
        <!-- Colletion items JS -->
        <script>
            var lines = [];
            var polygons = [];
            var points = [];

            $(function() {
                // get collection list
                $('button#getCollectionItems').bind('click', getCollectionList)
            });

            function getCollectionList(){
                var collId = $('input[name="collectionId"]').val();

                $.getJSON($SCRIPT_ROOT + '/collections/' +collId+ '/items', {
                    collectionId: collId,
                }, function(data) {
                    showJSONOutput(data, "#result");
                    saveObjects(data);
                    renderObjects();
                    return data;
                });

                return false;
            }

            function saveObjects(data) {
                data.forEach(element => {
                    switch (element.geometry.type) {
                        case "Polygon":
                            var obj = {
                                type: element.geometry.type,
                                coordinates: element.geometry.coordinates
                            }
                            polygons.push(obj);
                            break;
                        
                        case "Point":
                            var obj = {
                                type: element.geometry.type,
                                coordinates: element.geometry.coordinates
                            }
                            points.push(obj);
                    
                        default:
                            break;
                    }
                });
            }

            function showJSONOutput(data, target) {
                // Put beautified json
                $(target).text(JSON.stringify(data, null, 4));
            }

            function renderObjects() {
                // Setup map marker marker
                var geojsonMarkerOptions = {
                    radius: 8,
                    fillColor: "#ff7800",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };
                // Render polygons
                polygons.forEach(function(polygon) {
                    // Add to map custom polygons
                   var polygon = L.polygon(polygon.coordinates, {
                        weight: 1,
                        fillOpacity: 0.7,
                        color: 'red',
                        dashArray: '3'
                    }).addTo(map);
                    // Get the polygon center
                    var center = polygon.getCenter();
                    // Use center to put marker on map
                    var marker = L.marker(center).addTo(map);
                });
                // Render points
                points.forEach(function(point) {
                    var point = L.geoJSON(point, {
                        pointToLayer: function (feature, latlng) {
                            // Put the markeron map
                            L.marker(latlng).addTo(map);
                            // Show custom points
                            return L.circleMarker(latlng, geojsonMarkerOptions);
                        }
                    }).addTo(map);
                });
            }
        </script>

        <script>
        // Set map center
      	var map = L.map('mapid').setView([41.651454948560136, -0.8817493915557862], 4);
		// Set map first marker
		var mainMarker = L.marker([41.651454948560136, -0.8817493915557862]).addTo(map);
		mainMarker.bindPopup("Zaragoza").openPopup();
		// Get map tiles from localhost or OSM
		L.tileLayer('http://3.143.92.80/tileserver/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors and <a href="https://novadevs.com">Novadevs</a>'
		}).addTo(map);
        </script>
    </body>
</html>
