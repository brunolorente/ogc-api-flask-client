<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OGC API demo client (Daraa)</title>
        
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        
        <!-- Popper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        
        <!-- Bootstrap CSS and JS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        
        <!-- Leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
         <!-- Make sure you put this AFTER Leaflet's CSS -->
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
        
        <!-- Custom -->
        <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
        <script src="{{ url_for('static', filename='main.js') }}"></script>
    </head>

    <body>
        <div class="container-fluid ">
            <div class="row">
                <!-- toolbar -->
                <div class="col-6 d-flex">
                    {% for url,printable_name in links %}
                        <a href="{{url}}" class="badge badge-primary margin-auto" target="_blank">{{printable_name}}</a>
                    {% endfor %}
                </div>
                <div class="col-6">
                    <h1 class="text-right">
                        OGC API Demo (Daraa)
                    </h1>
                </div>
                <div class="col-12">
                    <hr>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <!-- map container -->
                    <div id="mapid"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <hr>
                </div>
            </div>

            <div class="row">
                <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                Get items by collection ID
                            </div>
                            <div class="card-body">
                                <div class="row form-group">
                                    <div class="col-12">
                                        <label for="collectionId">Feature collection ID</label>
                                        <input type="text" name="collectionId" id="collectionId" class="form-control" value="" placeholder="AgricultureSrf">
                                    </div>
                                </div>
                                <div class="row form-group">
                                    <div class="col-12">
                                        <label for="collectionId">N. of elements</label> <small>20 by default</small>
                                        <input type="text" name="limit" id="limit" class="form-control" value="20" placeholder="20">
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-muted">
                                <button id="getCollectionItems" class="btn btn-primary">Get items</button>
                                <button id="collentionItemsJsonOutput" type="button" disabled class="btn btn-primary" data-toggle="modal" data-target="#getCollectionItemsModal">Show JSON output</button>
                            </div>
                        </div>
                </div>

                <div class="col-4">
                    <div class="card">
                        <div class="card-header">
                            Get item by collection ID and item ID
                        </div>
                        <div class="card-body">
                            <div class="row form-group">
                                <div class="col-12">
                                    <label for="collectionIdFilter">Feature collection ID</label>
                                    <input disabled type="text" name="collectionIdFilter" id="collectionIdFilter" class="form-control disabled" value="" placeholder="AgricultureSrf">
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-12">
                                    <label for="elementId">Element ID</label>
                                    <input disabled type="text" name="elementId" id="elementId" class="form-control disabled" value="" placeholder="">
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-muted">
                            <button id="getCollectionItem" class="btn btn-primary disabled">Get item</button>
                            <button type="button" class="btn btn-primary disabled" data-toggle="modal" data-target="#getCollectionItemModal">Show JSON output</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- #getCollectionItemsModal -->
        <div class="modal fade" id="getCollectionItemsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">JSON output for <span id="selectedCollectionId"></span></h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <pre id="result"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
        </div>


        <footer>
            <hr>
            <p class="text-center">
                2021
            </p>
        </footer>


        <!-- Document root -->
        <script>
            $SCRIPT_ROOT = {{request.root_url|tojson|safe}};
        </script>
        <!-- Colletion items JS -->
        <script>
            /**
             * The lines ready to be rendered.
             *
             * @type {array}
             */
            var lines = [];
            /**
             * The polygons ready to be rendered.
             *
             * @type {array}
             */
            var polygons = [];
            /**
             * The points ready to be rendered.
             *
             * @type {array}
             */
            var points = [];

            $(function() {
                // get collection list
                $('button#getCollectionItems').bind('click', getCollectionItemList)
            });

            /** @function getCollectionItemList 
             * Do an AJAX call to get all the items that are part of a given collection.
             *
             * @returns {JSON}|{boolean}
             */
            function getCollectionItemList(){
                var collId = $('input[name="collectionId"]').val();
                var limit = $('input[name="limit"]').val();

                var $this = $(this);
                var loadingText = '<i class="fa fa-circle-o-notch fa-spin"></i> Loading...';
                if ($(this).html() !== loadingText) {
                    $this.data('original-text', $(this).html());
                    $this.html(loadingText);
                    $this.prop('disabled', true);

                }
     
                $.getJSON($SCRIPT_ROOT + '/collections/' +collId+ '/items', {
                    collectionId: collId,
                    l: limit,
                }, function(data) {
                    /** @function showJSONOutput */
                    showJSONOutput(data, "#result");
                    /** @function saveObjects */
                    saveObjects(data);
                    /** @function renderObjects */
                    renderObjects();
                    return data;
                }).done(function (data) {
                    $this.html($this.data('original-text'));
                    $this.removeAttr('disabled');
                    $('#collentionItemsJsonOutput').removeAttr('disabled');
                }).fail(function() {
                    $this.html($this.data('original-text'));
                    $this.removeAttr('disabled');
                });

                return false;
            }

            /** @function saveObjects 
             * Pushes each received object into the needed array
             * 
             * @returns {void}
             */
            function saveObjects(data) {
                data.forEach(element => {
                    switch (element.geometry.type) {
                        case "Polygon":
                            var obj = {
                                type: element.geometry.type,
                                coordinates: element.geometry.coordinates,
                                properties: element.properties,
                                id: element.id,
                            }
                            polygons.push(obj);
                            break;
                        
                        case "Point":
                            var obj = {
                                type: element.geometry.type,
                                coordinates: element.geometry.coordinates,
                                properties: element.properties,
                                id: element.id,
                            }
                            points.push(obj);
                    
                        default:
                            break;
                    }
                });
            }

            /** @function showJSONOutput 
             * Returns and puts the given JSON response into a modal window
             * 
             * @returns {void}
             */
            function showJSONOutput(data, target) {
                // Put beautified json
                // $(target).text(JSON.stringify(data, null, 4));
                $(target).empty().simpleJson({ jsonObject: data });
            }

            /** @function renderObjects 
             * Renders each stored object into the map
             * 
             * @returns {void}
             */
            function renderObjects() {
                // Render polygons
                polygons.forEach(function(polygon) {
                    // Add to map custom polygons
                    var pol = L.polygon(polygon.coordinates, {
                        weight: 1,
                        fillOpacity: 0.7,
                        color: 'red',
                        dashArray: '3'
                    }).addTo(map);
                    // Add tooltip to the polygon
                    var content = '<h4>'+polygon.id+' properties:</h4>';
                    var counter = 0;
                    for(var key in polygon.properties) {
                        if(polygon.properties.hasOwnProperty(key) && counter < 5) {
                            content += '<p>'+key+':'+polygon.properties[key]+'<p>';
                            counter++;
                        }
                    }
                    pol.bindTooltip(content).addTo(map);
                    // Get the polygon center
                    var center = pol.getCenter();
                    // Fly to the polygon center
                    map.flyTo([center.lat, center.lng], 9);
                });
                // Render points
                points.forEach(function(point) {
                    console.log(point);
                    var pt = L.geoJSON(point, {
                        pointToLayer: function (feature, latlng) {
                            // Put the markeron map
                            L.marker(latlng).addTo(map);
                            // Show custom points
                            return L.circleMarker(latlng, {
                                radius: 8,
                                fillColor: "#ff7800",
                                color: "#000",
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        }
                    }).addTo(map);
                    // Add tooltip to the point
                    var content = '<h4>'+point.id+' properties:</h4>';
                    var counter = 0;
                    for(var key in point.properties) {
                        if(point.properties.hasOwnProperty(key) && counter < 5) {
                            content += '<p>'+key+':'+point.properties[key]+'<p>';
                            counter++;
                        }
                    }
                    pt.bindTooltip(content).addTo(map);
                    // Fly to the point center
                    map.flyTo(pt.getBounds().getCenter(), 9);
                });
            }
        </script>

        <script>
        // Set map center and block zoom
      	var map = L.map('mapid', {
            scrollWheelZoom: false,
          }).setView([41.651454948560136, -0.8817493915557862], 4);
		// Get map tiles from localhost or OSM
		// L.tileLayer('http://3.143.92.80/tileserver/{z}/{x}/{y}.png', {
		L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors and <a href="https://novadevs.com">Novadevs</a>'
		}).addTo(map);
        </script>
    </body>
</html>
